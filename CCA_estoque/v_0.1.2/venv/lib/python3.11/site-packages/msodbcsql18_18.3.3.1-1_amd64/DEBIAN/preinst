#!/bin/bash -e

. /usr/share/debconf/confmodule

check_eula_acceptance()
{
    db_get msodbcsql/ACCEPT_EULA
    if [ "$RET" != "true" ] && [ "$ACCEPT_EULA" != "y" ] && [ "$ACCEPT_EULA" != "Y" ]; then
        db_set msodbcsql/accept_eula false
        db_fset msodbcsql/accept_eula seen false
        db_input high msodbcsql/accept_eula	|| true
        db_go

        db_get msodbcsql/accept_eula

        if [ "$RET" != "true" ]; then
            echo "ERROR: The EULA was not accepted. Installation aborted." >&2
            exit 1
        fi
    fi
    db_set msodbcsql/accept_eula true
}

# check if Driver is installed 
check_driver()
{
    exit_code=0
    odbcinst -q -d -n "ODBC Driver $1 for SQL Server" &>/dev/null || exit_code=$?
    if (( exit_code == 0 )) ; then
        # Driver found, abort the installation
        echo "Installation failed, ODBC Driver $1 for SQL Server detected!" >&2
        exit 1
    fi
}

case "$1" in
    install)
        # check if Driver 18 is installed 
        check_driver 18

        check_eula_acceptance
    ;;

    upgrade)
        check_eula_acceptance
    ;;

    abort-upgrade)
    ;;

    *)
        echo "preinst called with an unknown argument '$1'" >&2
        exit 1
esac

exit 0
